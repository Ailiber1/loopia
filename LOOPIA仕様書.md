# LOOPIA Webアプリ 仕様書（最終版 v2.0）

## 1. アプリ概要

**アプリ名**  
LOOPIA（ルーピア）

**目的**  
短い動画（5〜15秒）を元に、つなぎ目が分からないシームレスな長尺ループ動画を自動生成する。

**基本思想**
- 動画編集ツールではない
- 操作は最小限（4ボタンのみ）
- 説明を読まなくても使える
- 間違えても必ずやり直せる
- 余計な機能・データを持たない

**解決する課題**
- ループ動画の「つなぎ目」が不自然になる
- フェードやトランジションを使わずに自然につなぎたい
- 編集ソフトは重く、操作が複雑
- 短い動画を5分〜60分などの長尺にするのが面倒

**操作の流れ**  
```
動画を置く → 時間を選ぶ → 待つ → 完成
```

---

## 2. 技術構成

### 2.1 使用技術

**フロントエンド**
- React / Vue.js（SPA）
- HTML5 Video API
- Firebase SDK

**ホスティング**
- Firebase Hosting

**ストレージ**
- Firebase Storage（無料枠: 5GB）

**バックエンド**
- Firebase Functions（無料枠: 125,000秒/月）
- 用途: 軽量処理・進捗管理のみ

**動画処理**
- Google Colab（無料GPU枠）
- フレーム補間: RIFE / FILM / DAIN
- 動画処理: FFmpeg

### 2.2 アーキテクチャ

```
[ユーザー（Webブラウザ）]
   ↓ 動画アップロード
[Firebase Storage] ← 元動画保存
   ↓ 処理依頼
[Firebase Functions] → 進捗管理・API呼び出し
   ↓
[Google Colab（無料GPU）]
   1. 元動画から終端1秒・始端1秒を抽出
   2. フレーム補間でブリッジ生成（0.5〜1秒）
   3. 元動画 + ブリッジで1ループ完成
   4. 選択時間分ループ展開
   ↓ 完成動画アップロード
[Firebase Storage]
   ↓ ダウンロード
[ユーザー]
```

### 2.3 制約・方針

**完全無料運用**
- Firebase無料枠内
- Google Colab無料GPU枠内
- 有料API・外部サービス使用禁止

**処理時間の目安**
- 5秒動画 → 60分: 5〜10分
- 10秒動画 → 60分: 6〜12分

**同時処理制限**
- Google Colab制約により、順番待ち方式
- 待機中は「現在処理中: ○本待ち」と表示

---

## 3. ループ生成ロジック（詳細）

### 3.1 繋ぎ目補間の仕組み

**元動画の構造**
```
[動画A]
 ├─ 始端（0秒〜1秒）
 ├─ 中間
 └─ 終端（最後の1秒）
```

**繋ぎ目問題**
```
通常のループ:
[終端] → [始端]
    ↑ ここが不自然
```

**LOOPIAの解決方法**
```
[終端1秒] ─補間─→ [ブリッジ0.5〜1秒] ─補間─→ [始端1秒]
              ↑
    フレーム補間アルゴリズムで滑らかに繋ぐ
```

### 3.2 処理の流れ

```
┌─────────────────────────────────────────┐
│ 1. 元動画解析                            │
│    - 終端1秒を抽出                       │
│    - 始端1秒を抽出                       │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│ 2. フレーム補間（GPU処理）               │
│    - 終端→始端への中間フレーム生成       │
│    - 滑らかなブリッジ映像作成（0.5〜1秒）│
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│ 3. 1ループ完成                           │
│    元動画 + ブリッジ                     │
│    例: 5秒 + 1秒 = 6秒                   │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│ 4. ループ展開                            │
│    60分 = 3600秒 ÷ 6秒 = 600回ループ     │
└─────────────────────────────────────────┘
```

### 3.3 繋ぎ目の図解

```
動画A(5秒) → [ブリッジ1秒] → 動画A(5秒) → [ブリッジ1秒] → 動画A(5秒) ...
              ↑                ↑
           繋ぎ目1          繋ぎ目2
```

ユーザーには「動画Aがずっと流れている」ように見える。

### 3.4 補間処理の負荷

| 項目 | 詳細 |
|------|------|
| 補間対象 | **繋ぎ目1秒分のみ**（約30フレーム） |
| 元動画長による影響 | なし（5秒でも10秒でも同じ） |
| GPU処理時間 | 30秒〜2分 |
| CPU処理時間 | 2〜5分（非推奨） |
| ストレージ消費 | 60分動画で1.5〜3GB |

**重要**: 全フレームを補間するわけではないため、処理負荷は極めて軽い。

### 3.5 禁止事項

- ❌ クロスフェード
- ❌ ディゾルブ
- ❌ トランジション効果
- ✅ **フレーム補間のみ**で自然につなぐ

---

## 4. UI / UX 設計

### 4.1 デザイン方針

**コンセプト**
- シンプル
- 迷わない
- UIは主張しない
- 黙って仕事をする

**カラースキーム**
- ベース: ソフトダークグレー（#2a2a2a 〜 #3a3a3a）
- テキスト: 低コントラスト（#b0b0b0 〜 #d0d0d0）
- アクセント: オレンジ（#ff8c42）
- 背景: #1a1a1a

**禁止**
- SF感・ネオン・強い演出
- グラデーション多用
- 過剰なアニメーション

### 4.2 画面レイアウト

```
┌──────────────────────────────────────────────────────┐
│ LOOPIA                                   🌐 (JP/EN)  │
├────────────┬─────────────────────────────────────────┤
│            │                                         │
│  Upload    │        プレビューエリア                  │
│  [アイコン]│         (生成後に表示)                   │
│            │                                         │
│  Duration  │         🔁 (繋ぎ目ジャンプ)             │
│  [ 60 min] │                                         │
│            │          ▶ 再生ボタン                   │
│ Start Loop │                                         │
│  [ボタン]  │                                         │
│            │                                         │
│  Download  │                                         │
│  [ボタン]  │                                         │
│            │                                         │
│    🗑️      │                                         │
│            │                                         │
├────────────┴─────────────────────────────────────────┤
│ Generating seamless loop... ███████████░░░░ 75%     │
│ 推定残り時間: 約2分 / Estimated: About 2 min          │
└──────────────────────────────────────────────────────┘
```

**構成要素**
- 左上: 操作エリア（縦配置）
- 右側: プレビュー表示エリア
- 下部: 生成進行バー（処理中のみ表示）

---

## 5. 操作仕様（詳細）

### 5.1 言語切り替え

**配置**: 画面右上  
**表示**: 🌐 または JP / EN  
**動作**: クリックで日本語 ⇄ 英語切り替え  
**デフォルト**: 日本語  
**実装**: ページリロードなし、即座に切り替え

---

### 5.2 アップロードボタン

**表示文言**
- 日本語: アップロード
- 英語: Upload

**デザイン**
- アイコン: 📤 または ⬆️
- 常に表示
- サイズ: 160px × 50px程度

**仕様**
- 対応形式: MP4, MOV, AVI, WebM
- 推奨動画長: 5〜15秒
- 最大ファイルサイズ: 100MB
- アップロード後も同ボタンで差し替え可能
- 差し替え時の確認不要（即座に上書き）

**状態管理**

| 状態 | ボタン表示 | クリック可否 |
|------|-----------|-------------|
| 初期 | アップロード | ✅ 可能 |
| アップロード中 | アップロード中... | ❌ 無効 |
| 完了後 | アップロード | ✅ 可能（差し替え） |
| 生成中 | アップロード | ❌ 無効 |

---

### 5.3 時間（Duration）ボタン

**表示文言**
- 日本語: 時間
- 英語: Duration

**デザイン**
- プルダウン形式
- デフォルト表示: 60 min

**選択肢（固定）**
- 5 分 / 5 min
- 10 分 / 10 min
- 30 分 / 30 min
- **60 分 / 60 min**（デフォルト）

**仕様**
- 手動入力禁止
- プルダウン選択のみ
- アップロード完了後に有効化

**状態管理**

| 状態 | 表示 | 選択可否 |
|------|------|---------|
| 初期 | 60 min（グレーアウト） | ❌ 無効 |
| アップロード後 | 60 min | ✅ 可能 |
| 生成中 | 選択値（グレーアウト） | ❌ 無効 |

**変更理由**
- 90分・120分を削除
- 処理時間短縮とストレージ負荷軽減のため
- 最長60分で実用上十分

---

### 5.4 ループ開始ボタン

**表示文言**
- 日本語: ループ開始
- 英語: Start Loop

**デザイン**
- 色: オレンジ（アクセントカラー）
- サイズ: 160px × 50px程度
- 目立たせる（メインアクション）

**有効化条件**
- アップロード完了 ✅
- 時間選択済み ✅

**クリック後の動作**
1. 文言変更: 「生成中… / Processing…」
2. ボタン無効化（二重実行防止）
3. 全操作をロック
4. 下部に進行バー表示
5. 処理開始

**状態管理**

| 状態 | 表示 | クリック可否 |
|------|------|-------------|
| 初期 | ループ開始（グレー） | ❌ 無効 |
| 準備完了 | ループ開始（オレンジ） | ✅ 可能 |
| 生成中 | 生成中…（グレー） | ❌ 無効 |
| 完了後 | （非表示） | - |

---

### 5.5 ダウンロードボタン

**表示文言**
- 日本語: ダウンロード
- 英語: Download

**デザイン**
- アイコン: ⬇️
- 色: デフォルトグレー → ホバー時オレンジ

**表示条件**
- 生成完了後のみ表示

**動作**
- クリックで完成動画をダウンロード
- ファイル名: `LOOPIA_{YYYYMMDD_HHmmss}.mp4`
- 例: `LOOPIA_20250129_143052.mp4`

**状態管理**

| 状態 | 表示 | クリック可否 |
|------|------|-------------|
| 初期〜生成中 | （非表示） | - |
| 生成完了後 | ダウンロード | ✅ 可能 |

---

### 5.6 削除（リセット）アイコン

**表示**: 🗑️（赤色）  
**配置**: 操作エリア最下部  
**サイズ**: 24px × 24px程度

**表示条件**
- 動画アップロード後 ✅
- ループ開始前 ✅
- 生成中 ✅
- 生成完了後 ❌（非表示）

**クリック時の動作**
1. 確認ダイアログ表示
   ```
   現在の作業を破棄しますか？
   Discard current work?
   
   [キャンセル / Cancel]  [削除 / Delete]
   ```
2. 「削除」選択時:
   - 現在の動画を削除
   - 選択状態をリセット
   - 初期画面に戻る

**削除対象**
- アップロードした動画
- 生成中の一時ファイル
- 選択した時間設定

**削除しないもの**
- 完成済みの動画（ダウンロード済み前提）
- 履歴データ（そもそも保存していない）

---

## 6. プレビュー機能

### 6.1 基本再生

**表示タイミング**
- 生成完了後のみ
- 生成前・生成中は空白またはプレースホルダー

**再生仕様**
- 中央に ▶︎ 再生アイコン表示
- 自動再生なし
- クリックで再生開始
- 再生中は ⏸ 一時停止アイコンに変化
- 自動ループ再生（終端到達時に自動的に先頭へ）

**表示情報**
- 現在時刻 / 総時間（例: 00:15 / 60:00）
- 簡易プログレスバー（シーク不可）

**禁止機能**
- ❌ シークバーでのドラッグ操作
- ❌ クリックでの時間ジャンプ
- ❌ 早送り・巻き戻しボタン
- ❌ 再生速度変更

### 6.2 繋ぎ目ジャンプ（🔁）

**目的**  
長尺動画でも繋ぎ目の品質を素早く確認できるようにする

**配置**: プレビュー右上

**表示条件**
- 生成完了後のみ表示
- 生成中は非表示

**動作**
1. クリック時: ループ境界（繋ぎ目前後3秒）へジャンプ
2. 自動的に再生開始
3. 再クリックで次の繋ぎ目へ移動

**ジャンプ位置の計算例**
```
元動画: 5秒 + ブリッジ: 1秒 = 1ループ: 6秒
60分 = 3600秒 ÷ 6秒 = 600ループ

繋ぎ目位置:
- 1回目: 5秒地点（-3秒 = 2秒から再生）
- 2回目: 11秒地点（-3秒 = 8秒から再生）
- 3回目: 17秒地点
...
```

**UI表示**
- アイコンのみ（ツールチップ: 「繋ぎ目確認 / Check seams」）

---

## 7. 生成進行表示

**配置**: 画面下部（全幅）

**表示内容**
- テキスト: 処理ステージ名
- プログレスバー: 0〜100%
- 推定残り時間

**処理ステージ**
```
1. 動画解析中... / Analyzing video...        (0-10%)
2. 繋ぎ目補間中... / Interpolating seams...  (10-40%)
3. ループ生成中... / Generating loop...      (40-90%)
4. 最終処理中... / Finalizing...            (90-100%)
5. 完了 / Complete                          (100%)
```

**デザイン**
- バー色: オレンジ（#ff8c42）
- 背景: 暗灰色
- テキスト: 白または薄灰色
- 高さ: 60px程度

**表示条件**
- 「ループ開始」クリック後に出現
- 完了後は自動的にフェードアウト（2秒後消失）

**更新頻度**
- リアルタイム（WebSocketまたはポーリング）
- 3〜5秒ごとに進捗更新

---

## 8. データ管理

### 8.1 保存するデータ（最小限）

**保存対象**
```json
{
  "timestamp": "2025-01-29T12:34:56Z",
  "duration": 60,
  "video_length": 5,
  "status": "completed"
}
```

**用途**
- 利用傾向分析
- サービス改善

**保存場所**
- Firebase Firestore（軽量ドキュメント）

### 8.2 保存しないデータ

- ❌ 元動画ファイル
- ❌ 完成動画ファイル（24時間後自動削除）
- ❌ ユーザー個人情報
- ❌ 削除履歴
- ❌ アクセスログ（最小限の分析用のみ）

### 8.3 ファイル自動削除ポリシー

| ファイル種別 | 保持期間 |
|-------------|---------|
| 元動画 | 処理完了後即削除 |
| 一時ファイル | 処理完了後即削除 |
| 完成動画 | **24時間後自動削除** |
| エラー時ファイル | 即座に削除 |

**目的**
- ストレージコスト削減
- プライバシー保護
- サーバー負荷軽減

---

## 9. エラー処理

### 9.1 想定エラーと対応

| エラー種別 | 表示メッセージ | 対処 |
|-----------|---------------|------|
| 非対応形式 | 対応していない形式です<br>Unsupported format | ファイル選択に戻る |
| ファイルサイズ超過 | ファイルサイズが大きすぎます（上限100MB）<br>File too large (max 100MB) | ファイル選択に戻る |
| 動画が短すぎる | 動画が短すぎます（最低3秒）<br>Video too short (min 3s) | ファイル選択に戻る |
| アップロード失敗 | アップロードに失敗しました<br>Upload failed | 再試行ボタン表示 |
| 処理タイムアウト | 処理がタイムアウトしました<br>Processing timeout | 再試行ボタン表示 |
| サーバーエラー | 一時的なエラーが発生しました<br>Temporary error occurred | 再試行ボタン表示 |

### 9.2 エラー表示デザイン

**配置**: プレビューエリア中央  
**スタイル**:
- 背景: 半透明黒（rgba(0,0,0,0.8)）
- テキスト: 白
- アイコン: ⚠️（黄色）
- ボタン: 「再試行 / Retry」（オレンジ）

**表示例**
```
⚠️
アップロードに失敗しました
Upload failed

[再試行 / Retry]  [キャンセル / Cancel]
```

---

## 10. 技術実装ガイドライン

### 10.1 フロントエンド

**フレームワーク**: React推奨

**主要ライブラリ**
- Firebase SDK（v9+）
- React Router（不要：SPA単一ページ）
- 状態管理: Context API or Zustand

**ファイル構成例**
```
src/
├── App.jsx              # メインコンポーネント
├── components/
│   ├── UploadButton.jsx
│   ├── DurationSelect.jsx
│   ├── StartButton.jsx
│   ├── DownloadButton.jsx
│   ├── DeleteIcon.jsx
│   ├── Preview.jsx
│   ├── ProgressBar.jsx
│   └── LanguageToggle.jsx
├── hooks/
│   ├── useVideoUpload.js
│   ├── useVideoProcessing.js
│   └── useLanguage.js
├── services/
│   ├── firebase.js
│   └── colabAPI.js
└── styles/
    └── global.css
```

### 10.2 Firebase Functions

**関数一覧**
```javascript
// 1. 動画アップロード後のトリガー
exports.onVideoUploaded = functions.storage.object().onFinalize(...)

// 2. Colab API呼び出し
exports.startProcessing = functions.https.onCall(...)

// 3. 進捗状態の取得
exports.getProgress = functions.https.onCall(...)

// 4. 完成動画の自動削除（24時間後）
exports.cleanupOldVideos = functions.pubsub.schedule('every 1 hours').onRun(...)
```

### 10.3 Google Colab処理

**Colabノートブック構成**
```python
# 1. 環境セットアップ
!pip install rife-ncnn-vulkan-python

# 2. Firebase Storageから元動画ダウンロード

# 3. FFmpegで終端・始端抽出
# 終端1秒: video[-1s:]
# 始端1秒: video[:1s]

# 4. RIFEでフレーム補間
# 終端 → 始端への中間フレーム生成

# 5. 1ループ動画作成
# 元動画 + ブリッジ

# 6. ループ展開
# 指定時間分繰り返し

# 7. Firebase Storageにアップロード

# 8. 完了通知
```

**API化方法**
- ngrokでColabを外部公開
- またはFlask API化してFirebase Functionsから呼び出し

### 10.4 フレーム補間アルゴリズム選定

| アルゴリズム | 速度 | 品質 | 推奨 |
|-------------|------|------|------|
| RIFE | ⭐⭐⭐ | ⭐⭐⭐ | ✅ 推奨 |
| FILM | ⭐⭐ | ⭐⭐⭐⭐ | △ 処理重い |
| DAIN | ⭐ | ⭐⭐⭐⭐ | ❌ 非常に重い |

**推奨**: RIFE（速度と品質のバランス）

---

## 11. 開発フェーズ

### Phase 1: MVP（最小機能）
**期間**: 3〜5日

**実装内容**
- ✅ 基本UI（4ボタン）
- ✅ 動画アップロード
- ✅ 単純ループ生成（補間なし）
- ✅ ダウンロード

**目的**: UI/UX検証

---

### Phase 2: 繋ぎ目補間（簡易版）
**期間**: 2〜3日

**実装内容**
- ✅ クロスフェード方式
- ✅ 0.5秒フェード
- ✅ 進行バー表示

**目的**: 処理フロー検証

---

### Phase 3: 高品質補間
**期間**: 5〜7日

**実装内容**
- ✅ RIFE導入
- ✅ Google Colab連携
- ✅ フレーム補間実装
- ✅ エラーハンドリング

**目的**: 完成版リリース

---

### Phase 4: 最適化
**期間**: 2〜3日

**実装内容**
- ✅ 処理速度改善
- ✅ UI微調整
- ✅ 多言語対応完成
- ✅ ドキュメント整備

---

## 12. 禁止事項（再確認）

以下の機能は**絶対に追加しない**：

- ❌ 編集タイムライン
- ❌ 設定項目の追加
- ❌ チュートリアル
- ❌ ユーザー登録・ログイン
- ❌ 履歴・お気に入り機能
- ❌ SNS連携
- ❌ 有料プラン
- ❌ 広告表示

**理由**: シンプルさの維持、無料運用の厳守

---

## 13. 最終目標

LOOPIAは  
**「動画を置いて、時間を選んで、待つだけ」**  
で完成する、

- 静かで
- 軽量で
- 信頼できる

シームレスループ生成アプリである。

---

## 14. 付録

### A. 想定ユースケース

1. **作業用BGV（背景動画）**
   - 焚き火・波の音・雨音など
   - 5秒 → 60分ループ

2. **睡眠・瞑想用**
   - 星空タイムラプス
   - 10秒 → 60分ループ

3. **デジタルサイネージ**
   - 店舗・イベント用
   - 8秒 → 30分ループ

4. **Zoom/Teams背景**
   - 動的背景動画
   - 5秒 → 10分ループ

### B. 技術参考リンク

**フレーム補間**
- RIFE: https://github.com/megvii-research/ECCV2022-RIFE
- FILM: https://github.com/google-research/frame-interpolation

**Firebase**
- Firebase無料枠: https://firebase.google.com/pricing
- Firebase Functions: https://firebase.google.com/docs/functions

**FFmpeg**
- 公式ドキュメント: https://ffmpeg.org/documentation.html

### C. 見積もり

**開発期間**: 2〜3週間  
**開発者**: 1名（フルスタック）  
**運用コスト**: 月0円（無料枠内）

---

## 改版履歴

- v1.0 (2025-01-XX) 初版作成
- v2.0 (2025-01-29) 最終版
  - 繋ぎ目補間ロジック詳細化
  - 最長時間を60分に変更（90分・120分削除）
  - 技術構成の明確化
  - 処理負荷の再計算

---

**仕様書作成日**: 2025年1月29日  
**最終更新日**: 2025年1月29日  
**バージョン**: 2.0